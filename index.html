<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jack's Birthday Tribute</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <!-- Preload critical images -->
    <link rel="preload" as="image" href="photos/ali_5.HEIC" fetchpriority="high">
    <link rel="preload" as="image" href="photos/alex_1.HEIC" fetchpriority="high">
</head>
<body>
    <header class="hero">
        <div class="hero-content">
            <h1>Jack Weinberger</h1>
            <p class="subtitle">You are so loved!</p>
            <a href="gallery.html" class="gallery-link">View Photo Gallery</a>
            <div class="scroll-indicator">
                <p>Scroll Down</p>
                <div class="arrow">↓</div>
            </div>
        </div>
    </header>

    <section class="intro">
        <div class="container">
            <h2>30 years of Jack</h2>
            <p>Friends and family share their favorite memories and what makes you uniquely you.</p>
        </div>
    </section>

    <section class="entry" id="ali">
        <div class="container">
            <h2>Ali Eicher</h2>
            <div class="content-a">
                <div class="photo-gallery">
                    <img src="photos/ali_5.HEIC" alt="Ali and Jack">
                    <img src="photos/ali_2.JPG" alt="Ali and Jack">
                    <img src="photos/ali_3.HEIC" alt="Ali and Jack">
                    <img src="photos/ali_4.HEIC" alt="Ali and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>NYE 2025.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>Hair in his eyes Jack.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="alex">
        <div class="container">
            <h2>Alex Weinberger</h2>
            <div class="content-b">
                <div class="photo-gallery">
                    <img src="photos/alex_1.HEIC" alt="Alex and Jack">
                    <img src="photos/alex_2.HEIC" alt="Alex and Jack">
                    <img src="photos/alex_3.HEIC" alt="Alex and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>He put diesel in our car then hitchhiked home and left the keys out now broken car in the random persons car. And then we started a diesel equipment repair business.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>The most selfless person I know! And puts up with me far more than any reasonable person should.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="elana">
        <div class="container">
            <h2>Elana Klein</h2>
            <div class="content-a">
                <div class="photo-gallery">
                    <img src="photos/elana_1.heic" alt="Elana and Jack">
                    <img src="photos/elana_2.heic" alt="Elana and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>The time he and his brothers took me wine tasting in the north fork for my birthday, and we stopped at an alpaca farm and he got bit.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>I love Jack's sense of humor, the very first thing he ever said to me was describing someone I worked with as an archetypal lesbian and it made me laugh so hard I still remember it perfectly. He's always in a good mood and fun to joke around with!</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="greg">
        <div class="container">
            <h2>Greg Weinberger</h2>
            <div class="content-b">
                <div class="text full-width">
                    <h3>Favorite memory</h3>
                    <p>My favorite memory of him is hard. There's a lot. His sr great Year lax season and how he handled a tough loss after a crazy good season. Nonchalantly winning the Connecticut state chess championship, crushing my client's kid who threw a hissy fit. Driving with him to test out the route to Cameron in Houston before his first day of work. Correcting the guide at the museum of natural history who misidentified a diplodocus. Playing with Zoe, which he wont recall, he was too young. Maybe watching the history channel w him at a motel in bar harbor—Doubt he remembers, mattered a lot to his life.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="irene">
        <div class="container">
            <h2>Irene Weinberger</h2>
            <div class="content-a">
                <div class="photo-gallery">
                    <img src="photos/irene_1.HEIC" alt="Irene and Jack">
                    <img src="photos/irene_2.png" alt="Irene and Jack">
                    <img src="photos/irene_3.png" alt="Irene and Jack">
                    <img src="photos/irene_4.png" alt="Irene and Jack">
                    <img src="photos/irene_5.png" alt="Irene and Jack">
                    <img src="photos/irene_6.png" alt="Irene and Jack">
                    <img src="photos/irene_7.png" alt="Irene and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>a) Jack (age 9) falling over in long peals of laughter whenever we'd read, or I said, the words "blue footed boobies."<br>
                    b) Grandpa on the piano playing Buddy Holly's "Raining in my Heart," the 3 of us sitting on that black piano bench screeching out the words at the top of our lungs.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>Sooooo many unique things. Jack is a very serious human being. Super Serious. Jack is a very silly (in the very best way) human being. Super Silly. Both are very true.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="phil">
        <div class="container">
            <h2>Phil Odelfelt</h2>
            <div class="content-b">
                <div class="photo-gallery">
                    <img src="photos/phil_1.heic" alt="Phil and Jack">
                    <img src="photos/phil_2.HEIC" alt="Phil and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>Some of the best memories in my life are with Jack, starting with a party in the Hamptons that made the NY Times in 2013 and spans our adventures through Miami, NYC, and Hamptons.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>Jack has a deep commitment to his friends, and I am honored to call him one of my best friends. The connection is beyond a fun friend, he is someone who inspires me, and is there for me in tough times. He is someone I can trust with my life and I would walk through walls for him, as I know he would do for me.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="grant">
        <div class="container">
            <h2>Grant Mueller</h2>
            <div class="content-a">
                <div class="photo-gallery">
                    <img src="photos/grant_1.png" alt="Grant and Jack">
                    <img src="photos/grant_2.jpg" alt="Grant and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>My favorite memory with Jack is both of us trying not to throw up from altitude sickness in vail at dinner with my dad after a week of drinking in Cabo.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>My favorite unique thing about him is his love of reggaeton despite being the whitest person I know.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="diane">
        <div class="container">
            <h2>Diane Weinberger</h2>
            <div class="content-b">
                <div class="photo-gallery">
                    <img src="photos/diane_1.jpeg" alt="Diane and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>Favorite memory is tough because there are just so many that have us lying on the floor laughing. But I think this encapsulates Jack. At five years old, he confidently walked away with the head of admissions at Trinity, explaining to her how he was going to be a paleontologist for Halloween and wondering what she was going to be.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>I love that Jack is uniquely self-aware and oblivious. He honors his true self, 'leaning into his weirdness' as he once put it. He has somehow managed to thread the needle, so this reads as charming and "just Jack" and we love him for it. Personally, I adore that he is always game for an adventure or excursion outside of his comfort zone. This is us on the top of Angels Landing, Zion National Park.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="henry">
        <div class="container">
            <h2>Henry Blakeway Webb</h2>
            <div class="content-a">
                <div class="photo-gallery">
                    <img src="photos/henry_1.heic" alt="Henry and Jack">
                    <img src="photos/henry_2.JPG" alt="Henry and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>My friendship with Jack has lasted 25 years now so hard to put into one sentence.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>Jack is an incredibly intelligent person who is purposeful in everything that he does including being your friend. Goes out of the way to spend time and catch up with you and when you're with him you know it matters a lot to him. He's made me think about things I didn't know exist all while demonstrating he'd be there through thick and thin.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="sam">
        <div class="container">
            <h2>Sam Schwager</h2>
            <div class="content-b">
                <div class="text full-width">
                    <h3>Favorite memory</h3>
                    <p>Alborz connected me to Jack back in December 2023 we got a beer at Gadfly some dive bar near where I was living in Chelsea. We have similar jobs but beyond that we both immediately connected like long lost friends has been one of my favorite people ever since.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>Jack's a rare mix of extreme intelligence, curiosity, self awareness and humility. Ultimately means you can have real conversation with him but it always feels genuine and ends up devolving into a good time.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="alborz">
        <div class="container">
            <h2>Alborz Yazdi</h2>
            <div class="content-b">
                <div class="photo-gallery">
                    <img src="photos/alborz_1.png" alt="Alborz and Jack">
                    <img src="photos/alborz_2.png" alt="Alborz and Jack">
                    <img src="photos/alborz_3.png" alt="Alborz and Jack">
                    <img src="photos/alborz_4.png" alt="Alborz and Jack">
                    <img src="photos/alborz_5.png" alt="Alborz and Jack">
                    <img src="photos/alborz_6.png" alt="Alborz and Jack">
                    <img src="photos/alborz_7.png" alt="Alborz and Jack">
                    <img src="photos/alborz_8.png" alt="Alborz and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>One of my favorite memories — testing out our homebrew concoction at the Yale Vanderbilt polo game for the first time.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>That I can say a few random words and incapacitate Jack laughing and saying "what dude?!"</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="miles">
        <div class="container">
            <h2>Miles DeSouza</h2>
            <div class="content-a">
                <div class="photo-gallery">
                    <img src="photos/miles_1.JPEG" alt="Miles and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>Classic memories playing nba jam at his winos on 88th after preseason soccer— and when he randomly had a black kitten for a few days (named rocky?) but more specifically being high as hell at his crib when i introduced him to "zeitgeist: the movie" about the conspiracy of how bush did 9/11 and him being like umm turn this shit off immediately lol</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>Someone unique i love about him is how he stands lol, hard to explain but easy to recognize<br><br>And also most improve player in giving daps over the past 15 years easily.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="martin">
        <div class="container">
            <h2>Martin Urdapilleta</h2>
            <div class="content-b">
                <div class="photo-gallery">
                    <img src="photos/martin_1.heic" alt="Martin and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>Beer die in the hamptons / shenanigans in NY.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>Haha he's unique alr. A type of friend I would never find in Argentina (compliment way). Unique mix of funny, blunt, thoughtful / smart, kind / generous, and autistic. Lol jk on last one, love you man happy birthday!</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="patti">
        <div class="container">
            <h2>Patti Weinberger</h2>
            <div class="content-a">
                <div class="photo-gallery">
                    <img src="photos/patti_1.heic" alt="Patti and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>This is literally one of Jeff and my favorite pics from our wedding. Jack wanted to tell me something and the photographer got the perfect moment. We always entertained the big questions together - are there secret passages in Irene and Jerry's Smithtown house, whatever logic puzzle of the day Jack knew and we had to wrap our brains around.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>We appreciated his thoughtful inquisitiveness then and now. Thanks for putting this together and see you soon!</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="nicky">
        <div class="container">
            <h2>Nicky Weinberger</h2>
            <div class="content-b">
                <div class="photo-gallery">
                    <img src="photos/nicky_1.jpeg" alt="Nicky and Jack">
                    <img src="photos/nicky_2.jpeg" alt="Nicky and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>My favorite memory with Jack is our tex mex dinner in Austin where we talked about our developing life philosophies for probably three hours over the best dinner we'd ever had (fish al Diablo at a restaurant I'm sure Jack remembers the name of). This was one of maybe a hundred long life chats we've had over the years that serve as snapshots of who we were at given times in our lives, chats that have helped made me who I am today.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>I love that Jack is uniquely himself, in all his glory and weirdness. He knows who he is and what he believes in and he lives his values day in day out.<br><br>And I love that when Jack asks how you are he really cares, he doesn't want surface level stuff, he wants to dig into what's happening in your life, to share in your successes and your struggles with you.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="alexc">
        <div class="container">
            <h2>Alex Cooley</h2>
            <div class="content-a">
                <div class="photo-gallery">
                    <img src="photos/alexc_1.png" alt="Alex Cooley and Jack">
                    <img src="photos/alexc_2.png" alt="Alex Cooley and Jack">
                    <img src="photos/alexc_3.png" alt="Alex Cooley and Jack">
                </div>
                <div class="text">
                    <h3>Favorite thing about Jack</h3>
                    <p>I think one unique thing about Jack that I really admire is that he is always brings a very positive and upbeat energy which makes any event more fun - sharing a few group photos to illustrate that!</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="austin">
        <div class="container">
            <h2>Austin Brady</h2>
            <div class="content-b">
                <div class="photo-gallery">
                    <img src="photos/austin_1.PNG" alt="Austin and Jack">
                    <img src="photos/austin_2.png" alt="Austin and Jack">
                    <img src="photos/austin_3.png" alt="Austin and Jack">
                    <img src="photos/austin_4.png" alt="Austin and Jack">
                </div>
                <div class="text">
                    <h3>Favorite thing about Jack</h3>
                    <p>He's a very unique guy that isn't afraid of going against the mainstream or standing out. He has a lot of well-researched and strongly held opinions, which he often takes too far. Photo evidence showing him taking his Huberman/mindfulness/health beliefs too far in public (eventually leading to his inability to walk last year).</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="will">
        <div class="container">
            <h2>Will Berry</h2>
            <div class="content-a">
                <div class="photo-gallery">
                    <img src="photos/will_1.PNG" alt="Will and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>So many but serious note I've rly cherished the times him and I got one and one time after squash at the Yale club chatting in the sauna.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>Which leads into the unique thing I love about wino which is that he's both brilliant and sweet (albeit awkward about his emotions sometimes haha).</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="garrett">
        <div class="container">
            <h2>Garrett Yien</h2>
            <div class="content-b">
                <div class="photo-gallery">
                    <img src="photos/garrett_1.jpeg" alt="Garrett and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>A secret confession which is that harry and i tossed a perfume holder out his parents bathroom window in high school, and we're sorry.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="luc">
        <div class="container">
            <h2>Luc Ryan-Schrieber</h2>
            <div class="content-a">
                <div class="photo-gallery">
                    <img src="photos/luc_1.jpeg" alt="Luc and Jack">
                </div>
                <div class="text">
                    <h3>Favorite thing about Jack</h3>
                    <p>A special thing about him is we have had thousands of conversations and debates, and I have never been bored in over 20 years.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="zach">
        <div class="container">
            <h2>Zach Spohler</h2>
            <div class="content-b">
                <div class="photo-gallery">
                    <img src="photos/zach_1.heic" alt="Zach and Jack">
                    <img src="photos/zach_2.heic" alt="Zach and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>In the 5th grade we used to build exploding pens and highlighters together. Jack figured out you could take the spring out and put it back in the wrong order so that when you press the top the pen shoots open and the parts fly everywhere. The highlighters had an even bigger/stronger spring. I think Jack figured this out when we were bored in Hebrew school. We then turned it into a mini business and sold a few of the exploding highlighters for $5 until they got banned by teachers because people were shooting pens across the classroom.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="matt">
        <div class="container">
            <h2>Matt Gilman</h2>
            <div class="content-a">
                <div class="photo-gallery">
                    <img src="photos/matt_1.JPG" alt="Matt and Jack">
                    <img src="photos/matt_2.HEIC" alt="Matt and Jack">
                    <img src="photos/matt_3.jpeg" alt="Matt and Jack">
                    <img src="photos/matt_4.HEIC" alt="Matt and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>Riding mopeds through the hills in Thailand on our post-grad trip.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>He's so knowledgeable and always learning more, and brings interesting topics to any conversation.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="david">
        <div class="container">
            <h2>David Greenstein</h2>
            <div class="content-b">
                <div class="photo-gallery">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>When Jack decided to fill up his car with diesel.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="harry">
        <div class="container">
            <h2>Harry Wang</h2>
            <div class="content-a">
                <div class="photo-gallery">
                    <img src="photos/harry_1.heic" alt="Harry and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>Wrench vs goal post.</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>His hair but that's gone now.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="john">
        <div class="container">
            <h2>John Lancione</h2>
            <div class="content-b">
                <div class="photo-gallery">
                    <img src="photos/john_1.JPG" alt="John and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>N/A</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>N/A</p>
                </div>
            </div>
        </div>
    </section>

    <section class="entry" id="kabir">
        <div class="container">
            <h2>Kabir Samtani</h2>
            <div class="content-a">
                <div class="photo-gallery">
                    <img src="photos/kabir_1.jpeg" alt="Kabir and Jack">
                    <img src="photos/kabir_2.HEIC" alt="Kabir and Jack">
                    <img src="photos/kabir_3.heic" alt="Kabir and Jack">
                    <img src="photos/kabir_4.JPG" alt="Kabir and Jack">
                </div>
                <div class="text">
                    <h3>Favorite memory</h3>
                    <p>N/A</p>
                    <h3>Favorite thing about Jack</h3>
                    <p>N/A</p>
                </div>
            </div>
        </div>
    </section>

    <section class="final">
        <div class="container">
            <h2>Happy 30th Birthday, Jack!</h2>
            <p>We are lucky to love you,</p>
            <p class="signature">Your family & friends</p>
            <p class="date">March 28, 2025</p>
        </div>
    </section>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check if browser supports IndexedDB for caching
            const supportsIndexedDB = 'indexedDB' in window;
            let imageCache;
            
            // Store pending conversions to prevent multiple attempts
            const pendingConversions = new Set();
            
            // Track failed images to avoid repeated attempts
            const failedImages = new Set();
            
            // Initialize image cache if supported
            if (supportsIndexedDB) {
                const request = indexedDB.open('imageCache', 1);
                
                request.onupgradeneeded = function(event) {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('images')) {
                        db.createObjectStore('images', { keyPath: 'src' });
                    }
                };
                
                request.onsuccess = function(event) {
                    imageCache = event.target.result;
                };
                
                request.onerror = function(event) {
                    console.error('IndexedDB error:', event.target.error);
                };
            }
            
            // Find all images and prepare them
            const allImages = document.querySelectorAll('.photo-gallery img');
            
            // Replace all HEIC images with placeholder divs initially
            allImages.forEach(img => {
                const src = img.getAttribute('src');
                
                // Set attributes for all images
                img.setAttribute('loading', 'lazy');
                img.setAttribute('decoding', 'async');
                
                // Create a placeholder with consistent dimensions
                const placeholder = document.createElement('div');
                placeholder.className = 'image-placeholder';
                placeholder.dataset.src = src;
                placeholder.style.width = '100%';
                placeholder.style.height = '100%';
                placeholder.style.backgroundColor = '#f8f8f8';
                placeholder.style.borderRadius = '8px';
                placeholder.style.position = 'relative';
                
                // Add loading indicator to placeholder
                const indicator = document.createElement('div');
                indicator.className = 'loading-indicator';
                indicator.textContent = 'Loading...';
                indicator.style.position = 'absolute';
                indicator.style.top = '50%';
                indicator.style.left = '50%';
                indicator.style.transform = 'translate(-50%, -50%)';
                indicator.style.color = '#999';
                indicator.style.fontSize = '1.4rem';
                
                placeholder.appendChild(indicator);
                
                // Replace the image with the placeholder
                img.parentNode.replaceChild(placeholder, img);
            });
            
            // Use Intersection Observer with more conservative thresholds
            // Process only 2 images at a time
            let processingCount = 0;
            const maxProcessingCount = 2;
            const pendingElements = [];
            
            function processNextPending() {
                if (pendingElements.length === 0 || processingCount >= maxProcessingCount) {
                    return;
                }
                
                const element = pendingElements.shift();
                processingCount++;
                
                const src = element.dataset.src;
                
                // Skip if this image has already failed
                if (failedImages.has(src)) {
                    showImageError(element);
                    processingCount--;
                    setTimeout(processNextPending, 100);
                    return;
                }
                
                // Handle based on file type
                if (src.toLowerCase().endsWith('.heic')) {
                    // Skip if already processing
                    if (pendingConversions.has(src)) {
                        pendingElements.push(element);
                        processingCount--;
                        setTimeout(processNextPending, 100);
                        return;
                    }
                    
                    // Try to get from cache first
                    if (imageCache) {
                        getCachedImage(src)
                            .then(cachedImage => {
                                if (cachedImage) {
                                    // Use cached image
                                    replaceWithImage(element, URL.createObjectURL(cachedImage.blob));
                                } else {
                                    // Convert and cache
                                    convertHeicImage(element);
                                }
                            })
                            .catch(() => {
                                // Fallback to regular conversion
                                convertHeicImage(element);
                            });
                    } else {
                        // No cache available, convert directly
                        convertHeicImage(element);
                    }
                } else {
                    // Regular image - create a new img element
                    const img = document.createElement('img');
                    img.src = src;
                    img.alt = "Photo";
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '8px';
                    
                    // Handle load success
                    img.onload = function() {
                        element.parentNode.replaceChild(img, element);
                        processingCount--;
                        setTimeout(processNextPending, 100);
                    };
                    
                    // Handle load error
                    img.onerror = function() {
                        showImageError(element);
                        failedImages.add(src);
                        processingCount--;
                        setTimeout(processNextPending, 100);
                    };
                }
            }
            
            // Create a more conservative Intersection Observer
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const element = entry.target;
                        pendingElements.push(element);
                        observer.unobserve(element);
                        
                        // Try to process the next pending element
                        processNextPending();
                    }
                });
            }, {
                rootMargin: '100px 0px', // Smaller margin to load closer to viewport
                threshold: 0.1 // Require more visibility before loading
            });
            
            // Start observing placeholders
            document.querySelectorAll('.image-placeholder').forEach(placeholder => {
                imageObserver.observe(placeholder);
            });
            
            // Replace placeholder with actual image
            function replaceWithImage(placeholder, imageSrc) {
                const img = document.createElement('img');
                img.src = imageSrc;
                img.alt = "Photo";
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '8px';
                
                img.onload = function() {
                    placeholder.parentNode.replaceChild(img, placeholder);
                    processingCount--;
                    setTimeout(processNextPending, 100);
                };
                
                img.onerror = function() {
                    showImageError(placeholder);
                    failedImages.add(placeholder.dataset.src);
                    processingCount--;
                    setTimeout(processNextPending, 100);
                };
            }
            
            // Show error in place of image
            function showImageError(element) {
                const fallbackElement = document.createElement('div');
                fallbackElement.className = 'image-fallback';
                fallbackElement.style.width = '100%';
                fallbackElement.style.height = '280px';
                fallbackElement.style.backgroundColor = '#f8f8f8';
                fallbackElement.style.display = 'flex';
                fallbackElement.style.alignItems = 'center';
                fallbackElement.style.justifyContent = 'center';
                fallbackElement.style.borderRadius = '8px';
                fallbackElement.style.color = '#999';
                fallbackElement.style.fontSize = '1.4rem';
                fallbackElement.style.padding = '2rem';
                fallbackElement.style.textAlign = 'center';
                fallbackElement.textContent = 'Image unavailable';
                
                element.parentNode.replaceChild(fallbackElement, element);
            }
            
            // Get image from cache
            function getCachedImage(src) {
                return new Promise((resolve, reject) => {
                    if (!imageCache) {
                        reject(new Error('Cache not available'));
                        return;
                    }
                    
                    const transaction = imageCache.transaction(['images'], 'readonly');
                    const store = transaction.objectStore('images');
                    const request = store.get(src);
                    
                    request.onsuccess = function() {
                        resolve(request.result);
                    };
                    
                    request.onerror = function() {
                        reject(request.error);
                    };
                });
            }
            
            // Save image to cache
            function saveToCache(src, blob) {
                if (!imageCache) return;
                
                const transaction = imageCache.transaction(['images'], 'readwrite');
                const store = transaction.objectStore('images');
                store.put({
                    src: src,
                    blob: blob,
                    timestamp: Date.now()
                });
            }
            
            // Convert HEIC image with better error handling
            async function convertHeicImage(placeholder) {
                const src = placeholder.dataset.src;
                pendingConversions.add(src);
                
                try {
                    // Fetch the HEIC file with a shorter timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                    
                    const response = await fetch(src, { 
                        signal: controller.signal 
                    }).catch(error => {
                        clearTimeout(timeoutId);
                        throw error;
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch ${src}`);
                    }
                    
                    const blob = await response.blob();
                    
                    // Convert HEIC to JPEG with a timeout
                    const conversionPromise = new Promise((resolve, reject) => {
                        const conversionTimeout = setTimeout(() => {
                            reject(new Error('HEIC conversion timeout'));
                        }, 15000);
                        
                        heic2any({
                            blob: blob,
                            toType: 'image/jpeg',
                            quality: 0.7 // Lower quality for faster conversion
                        })
                        .then(result => {
                            clearTimeout(conversionTimeout);
                            resolve(result);
                        })
                        .catch(error => {
                            clearTimeout(conversionTimeout);
                            reject(error);
                        });
                    });
                    
                    const jpegBlob = await conversionPromise;
                    
                    // Cache the result for future use
                    saveToCache(src, jpegBlob);
                    
                    // Create object URL and replace placeholder
                    const jpegUrl = URL.createObjectURL(jpegBlob);
                    replaceWithImage(placeholder, jpegUrl);
                    
                } catch (error) {
                    console.error(`Error processing ${src}:`, error);
                    showImageError(placeholder);
                    failedImages.add(src);
                    processingCount--;
                    setTimeout(processNextPending, 100);
                } finally {
                    pendingConversions.delete(src);
                }
            }
        });
        
        // Define the styles
        if (!document.querySelector('#heic-spinner-style')) {
            const style = document.createElement('style');
            style.id = 'heic-spinner-style';
            style.textContent = `
                .image-placeholder {
                    background-color: #f8f8f8;
                    height: 280px;
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .loading-indicator {
                    color: #999;
                    font-size: 1.4rem;
                }
                
                .image-fallback {
                    background-image: linear-gradient(135deg, #f8f8f8 25%, #efefef 25%, #efefef 50%, #f8f8f8 50%, #f8f8f8 75%, #efefef 75%, #efefef 100%);
                    background-size: 20px 20px;
                }
                
                .gallery-link {
                    display: inline-block;
                    background-color: white;
                    color: var(--primary-color);
                    padding: 1.2rem 2.5rem;
                    border-radius: 3rem;
                    text-decoration: none;
                    font-weight: 600;
                    margin-bottom: 4rem;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
                }
                
                .gallery-link:hover {
                    background-color: var(--accent-color);
                    transform: translateY(-2px);
                    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
                }
                
                @media (max-width: 768px) {
                    .image-placeholder {
                        height: 220px;
                    }
                }
                
                @media (max-width: 480px) {
                    .image-placeholder {
                        height: 180px;
                    }
                }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html> 